<!--èŠå¤©é¡µé¢-->
<view class="chat-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">{{loadingText}}</text>
  </view>

  <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="message-list" 
    scroll-y="{{true}}"
    scroll-top="{{scrollTop}}"
    scroll-into-view="{{scrollIntoView}}"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
    wx:if="{{!loading}}"
  >
    <!-- æ¶ˆæ¯é¡¹ -->
    <view 
      class="message-item {{message.type === 'sent' ? 'message-sent' : 'message-received'}}"
      wx:for="{{messages}}"
      wx:key="id"
      id="message-{{message.id}}"
    >
      <!-- æ—¶é—´åˆ†éš”çº¿ -->
      <view class="time-divider" wx:if="{{message.showTime}}">
        <text class="time-text">{{message.timeText}}</text>
      </view>

      <!-- æ¶ˆæ¯å†…å®¹ -->
      <view class="message-content">
        <!-- æ¥æ”¶æ¶ˆæ¯çš„å¤´åƒ -->
        <view class="avatar-container" wx:if="{{message.type === 'received'}}">
          <image class="avatar" src="{{message.avatar || '/images/default-avatar.png'}}" mode="aspectFill" />
        </view>

        <!-- æ¶ˆæ¯æ°”æ³¡ -->
        <view class="message-bubble {{message.type === 'sent' ? 'bubble-sent' : 'bubble-received'}}">
          <!-- æ–‡æœ¬æ¶ˆæ¯ -->
          <view class="text-message" wx:if="{{message.messageType === 'text'}}">
            <text class="message-text" selectable="{{true}}">{{message.content}}</text>
          </view>

          <!-- å›¾ç‰‡æ¶ˆæ¯ -->
          <view class="image-message" wx:elif="{{message.messageType === 'image'}}">
            <image 
              class="message-image" 
              src="{{message.content}}" 
              mode="aspectFill"
              bindtap="onPreviewImage"
              data-url="{{message.content}}"
            />
          </view>

          <!-- è¯­éŸ³æ¶ˆæ¯ -->
          <view class="voice-message" wx:elif="{{message.messageType === 'voice'}}" bindtap="onPlayVoice" data-message="{{message}}">
            <view class="voice-icon {{message.playing ? 'voice-playing' : ''}}">
              <text class="iconfont icon-voice">ğŸ¤</text>
            </view>
            <text class="voice-duration">{{message.duration}}"</text>
          </view>

          <!-- ä½ç½®æ¶ˆæ¯ -->
          <view class="location-message" wx:elif="{{message.messageType === 'location'}}" bindtap="onViewLocation" data-message="{{message}}">
            <view class="location-icon">
              <text class="iconfont icon-location">ğŸ“</text>
            </view>
            <view class="location-info">
              <text class="location-name">{{message.locationName}}</text>
              <text class="location-address">{{message.locationAddress}}</text>
            </view>
          </view>

          <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
          <view class="system-message" wx:elif="{{message.messageType === 'system'}}">
            <text class="system-text">{{message.content}}</text>
          </view>
        </view>

        <!-- å‘é€æ¶ˆæ¯çš„å¤´åƒ -->
        <view class="avatar-container" wx:if="{{message.type === 'sent'}}">
          <image class="avatar" src="{{userInfo.avatar || '/images/default-avatar.png'}}" mode="aspectFill" />
        </view>
      </view>

      <!-- æ¶ˆæ¯çŠ¶æ€ -->
      <view class="message-status" wx:if="{{message.type === 'sent'}}">
        <view class="status-sending" wx:if="{{message.status === 'sending'}}">
          <view class="status-spinner"></view>
        </view>
        <view class="status-failed" wx:elif="{{message.status === 'failed'}}" bindtap="onResendMessage" data-message="{{message}}">
          <text class="iconfont icon-error">âŒ</text>
        </view>
        <view class="status-read" wx:elif="{{message.status === 'read'}}">
          <text class="read-text">å·²è¯»</text>
        </view>
      </view>
    </view>

    <!-- æ­£åœ¨è¾“å…¥æç¤º -->
    <view class="typing-indicator" wx:if="{{isTyping}}">
      <view class="typing-dots">
        <view class="dot"></view>
        <view class="dot"></view>
        <view class="dot"></view>
      </view>
      <text class="typing-text">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</text>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-container">
    <!-- å·¥å…·æ  -->
    <view class="toolbar" wx:if="{{showToolbar}}">
      <!-- å›¾ç‰‡é€‰æ‹© -->
      <view class="tool-item" bindtap="onSelectImage">
        <text class="tool-icon">ğŸ“·</text>
        <text class="tool-text">å›¾ç‰‡</text>
      </view>
      
      <!-- ä½ç½®åˆ†äº« -->
      <view class="tool-item" bindtap="onShareLocation">
        <text class="tool-icon">ğŸ“</text>
        <text class="tool-text">ä½ç½®</text>
      </view>
      
      <!-- è¯­éŸ³é€šè¯ -->
      <view class="tool-item" bindtap="onVoiceCall">
        <text class="tool-icon">ğŸ“</text>
        <text class="tool-text">é€šè¯</text>
      </view>
    </view>

    <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
    <view class="input-area">
      <!-- è¯­éŸ³æŒ‰é’® -->
      <view class="voice-btn" bindtap="onToggleInputType">
        <text class="voice-icon">{{inputType === 'text' ? 'ğŸ¤' : 'âŒ¨ï¸'}}</text>
      </view>

      <!-- æ–‡æœ¬è¾“å…¥ -->
      <view class="text-input-container" wx:if="{{inputType === 'text'}}">
        <textarea 
          class="text-input"
          placeholder="è¯·è¾“å…¥æ¶ˆæ¯..."
          value="{{inputText}}"
          bindinput="onInputChange"
          bindconfirm="onSendText"
          confirm-type="send"
          auto-height="{{true}}"
          maxlength="500"
          show-confirm-bar="{{false}}"
          adjust-position="{{true}}"
        />
      </view>

      <!-- è¯­éŸ³å½•åˆ¶ -->
      <view class="voice-input-container" wx:else>
        <view 
          class="voice-record-btn {{isRecording ? 'recording' : ''}}"
          bindtouchstart="onStartRecord"
          bindtouchend="onEndRecord"
          bindtouchcancel="onCancelRecord"
        >
          <text class="record-text">{{isRecording ? 'æ¾å¼€å‘é€' : 'æŒ‰ä½è¯´è¯'}}</text>
        </view>
      </view>

      <!-- è¡¨æƒ…/å·¥å…·æŒ‰é’® -->
      <view class="emoji-btn" bindtap="onToggleToolbar">
        <text class="emoji-icon">{{showToolbar ? 'âŒ¨ï¸' : 'ğŸ˜Š'}}</text>
      </view>

      <!-- å‘é€æŒ‰é’® -->
      <view 
        class="send-btn {{inputText.trim() ? 'send-active' : ''}}"
        bindtap="onSendText"
        wx:if="{{inputType === 'text' && inputText.trim()}}"
      >
        <text class="send-text">å‘é€</text>
      </view>
    </view>
  </view>

  <!-- è¯­éŸ³å½•åˆ¶æç¤º -->
  <view class="voice-recording-modal" wx:if="{{isRecording}}">
    <view class="recording-content">
      <view class="recording-icon">
        <text class="record-wave">ğŸ¤</text>
      </view>
      <text class="recording-text">æ­£åœ¨å½•éŸ³...</text>
      <text class="recording-tip">ä¸Šæ»‘å–æ¶ˆå‘é€</text>
    </view>
  </view>

  <!-- é”™è¯¯æç¤º -->
  <view class="error-toast" wx:if="{{showError}}">
    <text class="error-text">{{errorMessage}}</text>
  </view>
</view>