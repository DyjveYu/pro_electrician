<!--电工端工单列表页面-->
<view class="orders-container">
  <!-- 筛选栏 -->
  <view class="filter-section">
    <scroll-view class="filter-scroll" scroll-x="true">
      <view class="filter-item {{currentFilter === 'all' ? 'active' : ''}}" 
            bindtap="onFilterChange" data-filter="all">
        <text>全部工单</text>
      </view>
      <view class="filter-item {{currentFilter === 'accepted' ? 'active' : ''}}" 
            bindtap="onFilterChange" data-filter="accepted">
        <text>已接单</text>
      </view>
      <view class="filter-item {{currentFilter === 'in_progress' ? 'active' : ''}}" 
            bindtap="onFilterChange" data-filter="in_progress">
        <text>进行中</text>
      </view>
      <view class="filter-item {{currentFilter === 'completed' ? 'active' : ''}}" 
            bindtap="onFilterChange" data-filter="completed">
        <text>已完成</text>
      </view>
      <view class="filter-item {{currentFilter === 'cancelled' ? 'active' : ''}}" 
            bindtap="onFilterChange" data-filter="cancelled">
        <text>已取消</text>
      </view>
    </scroll-view>
  </view>

  <!-- 工单列表 -->
  <view class="orders-section">
    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-state">
      <view class="loading-spinner"></view>
      <text>加载中...</text>
    </view>

    <!-- 工单列表 -->
    <view wx:else class="orders-list">
      <view wx:for="{{orderList}}" wx:key="id" class="order-item" 
            bindtap="onOrderDetail" data-id="{{item.id}}">
        <!-- 工单头部 -->
        <view class="order-header">
          <view class="order-type">
            <text class="type-icon">{{item.serviceTypeIcon}}</text>
            <text class="type-name">{{item.serviceTypeName}}</text>
          </view>
          <view class="order-status {{item.statusClass}}">
            <text>{{item.statusText}}</text>
          </view>
        </view>

        <!-- 工单内容 -->
        <view class="order-content">
          <view class="order-info">
            <view class="info-row">
              <text class="iconfont icon-time"></text>
              <text class="info-text">{{item.createTimeText}}</text>
              <text wx:if="{{item.isUrgent}}" class="urgent-tag">紧急</text>
            </view>
            <view class="info-row">
              <text class="iconfont icon-location"></text>
              <text class="info-text">{{item.address}}</text>
              <text class="distance">{{item.distance}}</text>
            </view>
            <view class="info-row">
              <text class="iconfont icon-user"></text>
              <text class="info-text">{{item.customerName}}</text>
              <text class="customer-phone">{{item.customerPhone}}</text>
            </view>
          </view>

          <!-- 故障描述 -->
          <view class="order-description">
            <text>{{item.description}}</text>
          </view>

          <!-- 问题图片 -->
          <view wx:if="{{item.images && item.images.length > 0}}" class="order-images">
            <image wx:for="{{item.images}}" wx:for-item="img" wx:key="*this" 
                   class="problem-image" src="{{img}}" mode="aspectFill"
                   bindtap="onPreviewImage" data-current="{{img}}" data-urls="{{item.images}}"></image>
          </view>

          <!-- 服务时间 -->
          <view wx:if="{{item.serviceTime}}" class="service-time">
            <text class="iconfont icon-clock"></text>
            <text>服务时间：{{item.serviceTimeText}}</text>
          </view>

          <!-- 维修进度 -->
          <view wx:if="{{item.status === 'in_progress' && item.repairProgress}}" class="repair-progress">
            <view class="progress-header">
              <text class="iconfont icon-tool"></text>
              <text>维修进度</text>
            </view>
            <view class="progress-content">
              <text>{{item.repairProgress}}</text>
            </view>
          </view>
        </view>

        <!-- 工单底部 -->
        <view class="order-footer">
          <view class="price-info">
            <text class="price-label">服务费用：</text>
            <text class="price-amount">¥{{item.actualPrice || item.estimatedPrice}}</text>
          </view>
          
          <!-- 操作按钮 -->
          <view class="order-actions">
            <!-- 已接单状态 -->
            <block wx:if="{{item.status === 'accepted'}}">
              <button class="action-btn primary" 
                      bindtap="onStartService" data-id="{{item.id}}">
                开始服务
              </button>
              <button class="action-btn secondary" 
                      bindtap="onContactCustomer" data-phone="{{item.customerPhone}}">
                联系客户
              </button>
            </block>
            
            <!-- 进行中状态 -->
            <block wx:elif="{{item.status === 'in_progress'}}">
              <button class="action-btn primary" 
                      bindtap="onUpdateProgress" data-id="{{item.id}}">
                更新进度
              </button>
              <button class="action-btn success" 
                      bindtap="onCompleteService" data-id="{{item.id}}">
                完成服务
              </button>
            </block>
            
            <!-- 已完成状态 -->
            <block wx:elif="{{item.status === 'completed'}}">
              <button class="action-btn secondary" 
                      bindtap="onViewReport" data-id="{{item.id}}">
                查看报告
              </button>
              <button wx:if="{{!item.hasRating}}" class="action-btn secondary" 
                      bindtap="onRateCustomer" data-id="{{item.id}}">
                评价客户
              </button>
            </block>
            
            <!-- 通用操作 -->
            <button class="action-btn secondary" 
                    bindtap="onOrderDetail" data-id="{{item.id}}">
              查看详情
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view wx:if="{{!loading && orderList.length === 0}}" class="empty-state">
      <image class="empty-icon" src="/images/empty-orders.png" mode="aspectFit"></image>
      <text class="empty-text">暂无{{filterText}}工单</text>
      <text class="empty-tip">{{emptyTip}}</text>
      <button wx:if="{{currentFilter === 'all'}}" class="refresh-btn" bindtap="onGoToDashboard">
        去工单大厅
      </button>
      <button wx:else class="refresh-btn" bindtap="onRefresh">
        刷新
      </button>
    </view>

    <!-- 加载更多 -->
    <view wx:if="{{!loading && orderList.length > 0}}" class="load-more">
      <view wx:if="{{hasMore}}" class="load-more-btn" bindtap="onLoadMore">
        <text>加载更多</text>
      </view>
      <view wx:else class="no-more">
        <text>没有更多工单了</text>
      </view>
    </view>
  </view>
</view>

<!-- 更新进度弹窗 -->
<view wx:if="{{showProgressModal}}" class="modal-overlay" bindtap="onCloseProgressModal">
  <view class="progress-modal" catchtap="">
    <view class="modal-header">
      <text class="modal-title">更新维修进度</text>
      <text class="modal-close" bindtap="onCloseProgressModal">×</text>
    </view>
    <view class="modal-content">
      <textarea class="progress-input" 
                placeholder="请描述当前维修进度..." 
                value="{{progressText}}"
                bindinput="onProgressInput"
                maxlength="200"></textarea>
      <view class="char-count">{{progressText.length}}/200</view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="onCloseProgressModal">取消</button>
      <button class="modal-btn confirm" bindtap="onConfirmProgress">确定</button>
    </view>
  </view>
</view>

<!-- 完成服务弹窗 -->
<view wx:if="{{showCompleteModal}}" class="modal-overlay" bindtap="onCloseCompleteModal">
  <view class="complete-modal" catchtap="">
    <view class="modal-header">
      <text class="modal-title">完成服务</text>
      <text class="modal-close" bindtap="onCloseCompleteModal">×</text>
    </view>
    <view class="modal-content">
      <view class="form-item">
        <text class="form-label">实际费用</text>
        <input class="form-input" 
               type="digit" 
               placeholder="请输入实际费用" 
               value="{{actualPrice}}"
               bindinput="onActualPriceInput" />
      </view>
      <view class="form-item">
        <text class="form-label">维修总结</text>
        <textarea class="form-textarea" 
                  placeholder="请描述维修过程和结果..." 
                  value="{{repairSummary}}"
                  bindinput="onRepairSummaryInput"
                  maxlength="500"></textarea>
        <view class="char-count">{{repairSummary.length}}/500</view>
      </view>
      <view class="form-item">
        <text class="form-label">维修后照片</text>
        <view class="upload-images">
          <view wx:for="{{afterImages}}" wx:key="*this" class="upload-item">
            <image class="upload-image" src="{{item}}" mode="aspectFill"></image>
            <text class="delete-btn" bindtap="onDeleteAfterImage" data-index="{{index}}">×</text>
          </view>
          <view wx:if="{{afterImages.length < 3}}" class="upload-btn" bindtap="onUploadAfterImage">
            <text class="iconfont icon-camera"></text>
            <text>添加照片</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="onCloseCompleteModal">取消</button>
      <button class="modal-btn confirm" bindtap="onConfirmComplete">完成服务</button>
    </view>
  </view>
</view>