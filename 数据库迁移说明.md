# 数据库迁移说明文档

## 概述

本文档提供了将电工维修平台数据库迁移到云MySQL的完整指南。我们已经修正了技术架构文档中的SQL脚本，并提供了两个迁移脚本文件。

## 问题修正

### 发现的主要差异

1. **主键类型差异**
   - 文档中使用：`VARCHAR(32) PRIMARY KEY DEFAULT (REPLACE(UUID(), '-', ''))`
   - 实际模型使用：`INT PRIMARY KEY AUTO_INCREMENT`

2. **字段缺失**
   - 文档中缺少多个实际模型中的重要字段
   - 索引定义不完整

3. **表名不一致**
   - 文档中：`evaluations`
   - 实际模型：`reviews`

### 已修正内容

✅ 更新了技术架构文档中的所有SQL脚本  
✅ 统一了主键类型为INTEGER自增  
✅ 补充了所有缺失的字段  
✅ 修正了表名和索引定义  
✅ 添加了完整的外键约束  
✅ **重要修正**：将工单表字段名从`order_number`改为`order_no`以匹配程序代码  

## 迁移脚本文件

### 1. database_init.sql
- **用途**：本地开发环境初始化
- **包含**：完整表结构 + 测试数据
- **适用场景**：开发、测试环境

### 2. cloud_mysql_migration.sql
- **用途**：生产环境云数据库迁移
- **包含**：完整表结构 + 基础管理员数据
- **适用场景**：阿里云RDS、腾讯云MySQL等生产环境

### 3. database_migration.sql
- **用途**：通用迁移脚本
- **包含**：完整表结构 + 少量示例数据
- **适用场景**：任何MySQL环境

## 使用指南

### 本地开发环境

```bash
# 1. 连接到本地MySQL
mysql -u root -p

# 2. 创建数据库
CREATE DATABASE electrician_platform DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE electrician_platform;

# 3. 执行初始化脚本
source database_init.sql;
```

### 云MySQL生产环境

#### 阿里云RDS MySQL

```bash
# 1. 通过阿里云控制台或命令行连接
mysql -h your-rds-endpoint -u username -p

# 2. 选择数据库
USE your_database_name;

# 3. 执行迁移脚本
source cloud_mysql_migration.sql;
```

#### 腾讯云MySQL

```bash
# 1. 连接到腾讯云MySQL实例
mysql -h your-cdb-endpoint -P 3306 -u username -p

# 2. 选择数据库
USE your_database_name;

# 3. 执行迁移脚本
source cloud_mysql_migration.sql;
```

### 通过数据库管理工具

#### 使用Navicat
1. 连接到目标数据库
2. 右键数据库 → 运行SQL文件
3. 选择对应的迁移脚本文件
4. 执行脚本

#### 使用phpMyAdmin
1. 登录phpMyAdmin
2. 选择目标数据库
3. 点击"导入"选项卡
4. 选择迁移脚本文件
5. 点击执行

#### 使用DBeaver
1. 连接到数据库
2. 打开SQL编辑器
3. 复制粘贴脚本内容或导入文件
4. 执行脚本

## 验证迁移结果

### 1. 检查表结构

```sql
-- 查看所有表
SHOW TABLES;

-- 查看表结构
DESC users;
DESC electricians;
DESC orders;
DESC payments;
DESC reviews;
```

### 2. 检查索引

```sql
-- 查看各表的索引
SHOW INDEX FROM users;
SHOW INDEX FROM electricians;
SHOW INDEX FROM orders;
SHOW INDEX FROM payments;
SHOW INDEX FROM reviews;
```

### 3. 检查外键约束

```sql
-- 查看外键约束
SELECT 
    TABLE_NAME,
    COLUMN_NAME,
    CONSTRAINT_NAME,
    REFERENCED_TABLE_NAME,
    REFERENCED_COLUMN_NAME
FROM information_schema.KEY_COLUMN_USAGE
WHERE TABLE_SCHEMA = DATABASE()
AND REFERENCED_TABLE_NAME IS NOT NULL;
```

### 4. 验证数据完整性

```sql
-- 检查表是否创建成功
SELECT 
    TABLE_NAME as '表名',
    TABLE_COMMENT as '表注释',
    TABLE_ROWS as '行数'
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = DATABASE() 
AND TABLE_TYPE = 'BASE TABLE'
ORDER BY TABLE_NAME;
```

## 环境变量配置

迁移完成后，需要更新应用程序的数据库连接配置：

### .env 文件示例

```env
# 数据库配置
DB_HOST=your-cloud-mysql-host
DB_PORT=3306
DB_NAME=your_database_name
DB_USER=your_username
DB_PASSWORD=your_password
DB_DIALECT=mysql

# 连接池配置
DB_POOL_MAX=20
DB_POOL_MIN=5
DB_POOL_ACQUIRE=30000
DB_POOL_IDLE=10000
```

### Sequelize配置更新

确保 `api/config/database.js` 中的配置与云数据库匹配：

```javascript
module.exports = {
  development: {
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    database: process.env.DB_NAME,
    username: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    dialect: 'mysql',
    timezone: '+08:00',
    pool: {
      max: 20,
      min: 5,
      acquire: 30000,
      idle: 10000
    }
  }
};
```

## 常见问题解决

### 1. 字符集问题

```sql
-- 检查数据库字符集
SHOW VARIABLES LIKE 'character_set%';

-- 如果需要修改
ALTER DATABASE your_database_name CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 2. 权限问题

```sql
-- 检查用户权限
SHOW GRANTS FOR 'your_username'@'%';

-- 授予必要权限（需要管理员执行）
GRANT ALL PRIVILEGES ON your_database_name.* TO 'your_username'@'%';
FLUSH PRIVILEGES;
```

### 3. 连接超时问题

```sql
-- 检查超时设置
SHOW VARIABLES LIKE '%timeout%';

-- 调整超时时间（如果有权限）
SET GLOBAL wait_timeout = 28800;
SET GLOBAL interactive_timeout = 28800;
```

### 4. JSON字段兼容性

确保MySQL版本支持JSON字段类型（MySQL 5.7+）：

```sql
-- 检查MySQL版本
SELECT VERSION();
```

## 性能优化建议

### 1. 索引优化

脚本已包含必要的索引，但可根据实际查询需求添加复合索引：

```sql
-- 示例：为常用查询组合添加复合索引
CREATE INDEX idx_orders_status_created ON orders(status, created_at);
CREATE INDEX idx_electricians_status_rating ON electricians(verification_status, rating);
```

### 2. 分区表（大数据量时）

```sql
-- 示例：按月分区orders表
ALTER TABLE orders PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    -- 继续添加分区...
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 3. 定期维护

```sql
-- 分析表统计信息
ANALYZE TABLE users, electricians, orders, payments, reviews;

-- 优化表
OPTIMIZE TABLE users, electricians, orders, payments, reviews;
```

## 备份策略

### 1. 迁移前备份

```bash
# 备份原数据库
mysqldump -u username -p original_database > backup_before_migration.sql
```

### 2. 定期备份

```bash
# 每日备份脚本示例
#!/bin/bash
DATE=$(date +"%Y%m%d_%H%M%S")
mysqldump -u username -p electrician_platform > backup_${DATE}.sql
```

## 监控和日志

### 1. 慢查询监控

```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;
```

### 2. 连接数监控

```sql
-- 查看当前连接数
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Max_used_connections';
```

## 总结

1. ✅ **问题已解决**：修正了文档与实际模型的差异
2. ✅ **脚本已提供**：三个不同用途的迁移脚本
3. ✅ **文档已更新**：技术架构文档中的SQL脚本已修正
4. ✅ **指南完整**：提供了详细的使用和验证指南

现在您可以安全地使用提供的迁移脚本将数据库部署到云MySQL环境。建议先在测试环境验证，确认无误后再在生产环境执行。