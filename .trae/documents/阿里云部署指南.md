# 电工维修平台阿里云部署指南

## 1. 系统要求和服务器配置

### 1.1 推荐服务器配置

**基础配置（适合测试环境）：**
- CPU: 2核
- 内存: 4GB
- 存储: 40GB SSD
- 带宽: 1Mbps
- 操作系统: Ubuntu 20.04 LTS 或 CentOS 8

**生产环境配置：**
- CPU: 4核
- 内存: 8GB
- 存储: 100GB SSD
- 带宽: 5Mbps
- 操作系统: Ubuntu 20.04 LTS 或 CentOS 8

### 1.2 阿里云产品选择

- **ECS实例**: 选择通用型g6或计算型c6实例
- **RDS数据库**: MySQL 8.0版本，至少2核4GB
- **SLB负载均衡**: 可选，用于高可用部署
- **CDN**: 可选，用于静态资源加速
- **SSL证书**: 免费或付费SSL证书

## 2. 运行环境安装

### 2.1 系统更新和基础工具

```bash
# Ubuntu系统
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl wget git vim unzip

# CentOS系统
sudo yum update -y
sudo yum install -y curl wget git vim unzip
```

### 2.2 安装Node.js

```bash
# 使用NodeSource官方源安装Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 或者使用nvm安装（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
nvm alias default 18

# 验证安装
node --version
npm --version
```

### 2.3 安装MySQL（如果不使用RDS）

```bash
# Ubuntu安装MySQL
sudo apt install -y mysql-server
sudo mysql_secure_installation

# CentOS安装MySQL
sudo yum install -y mysql-server
sudo systemctl start mysqld
sudo systemctl enable mysqld
sudo mysql_secure_installation

# 创建数据库和用户
sudo mysql -u root -p
CREATE DATABASE pro_electrician CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'electrician'@'localhost' IDENTIFIED BY 'your_strong_password';
GRANT ALL PRIVILEGES ON pro_electrician.* TO 'electrician'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 2.4 安装Nginx

```bash
# Ubuntu
sudo apt install -y nginx

# CentOS
sudo yum install -y nginx

# 启动并设置开机自启
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 2.5 安装PM2（进程管理器）

```bash
npm install -g pm2

# 设置PM2开机自启
pm2 startup
# 按照提示执行相应命令
```

### 2.6 安装Redis（可选）

```bash
# Ubuntu
sudo apt install -y redis-server

# CentOS
sudo yum install -y redis

# 启动Redis
sudo systemctl start redis
sudo systemctl enable redis
```

## 3. 代码部署步骤

### 3.1 创建部署目录

```bash
# 创建应用目录
sudo mkdir -p /var/www/pro-electrician
sudo chown -R $USER:$USER /var/www/pro-electrician
cd /var/www/pro-electrician
```

### 3.2 上传代码文件

**需要上传的文件和目录：**

```
pro-electrician/
├── api/                    # 后端API代码
│   ├── app.js             # 主应用文件
│   ├── config/            # 配置文件
│   ├── controllers/       # 控制器
│   ├── middleware/        # 中间件
│   ├── models/            # 数据模型
│   ├── routes/            # 路由
│   ├── services/          # 服务层
│   └── utils/             # 工具函数
├── package.json           # 依赖配置
├── package-lock.json      # 锁定版本
├── .env.example           # 环境变量示例
└── README.md              # 说明文档
```

**上传方法：**

```bash
# 方法1: 使用Git克隆（推荐）
git clone https://github.com/your-username/pro-electrician.git .

# 方法2: 使用SCP上传
# 在本地执行
scp -r ./pro-electrician/* root@your-server-ip:/var/www/pro-electrician/

# 方法3: 使用rsync同步
rsync -avz --exclude 'node_modules' --exclude '.git' ./pro-electrician/ root@your-server-ip:/var/www/pro-electrician/
```

### 3.3 安装依赖

```bash
cd /var/www/pro-electrician
npm install --production
```

### 3.4 配置环境变量

```bash
# 复制环境变量文件
cp .env.example .env

# 编辑环境变量
vim .env
```

**生产环境配置示例：**

```env
# 服务器配置
PORT=3000
NODE_ENV=production

# 数据库配置（RDS）
DB_HOST=your-rds-endpoint.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_NAME=pro_electrician
DB_USER=your_db_user
DB_PASSWORD=your_db_password

# JWT配置
JWT_SECRET=your_super_secret_jwt_key_here_make_it_long_and_random
JWT_EXPIRES_IN=7d

# 微信小程序配置
WECHAT_APPID=your_wechat_appid
WECHAT_SECRET=your_wechat_secret

# 微信支付配置
WECHAT_PAY_MCHID=your_merchant_id
WECHAT_PAY_KEY=your_pay_key
WECHAT_PAY_CERT_PATH=/var/www/pro-electrician/certs/apiclient_cert.pem
WECHAT_PAY_KEY_PATH=/var/www/pro-electrician/certs/apiclient_key.pem

# 文件上传配置
UPLOAD_PATH=/var/www/pro-electrician/uploads
MAX_FILE_SIZE=5242880

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# 日志配置
LOG_LEVEL=info
LOG_PATH=/var/www/pro-electrician/logs
```

### 3.5 创建必要目录

```bash
# 创建上传和日志目录
mkdir -p /var/www/pro-electrician/uploads
mkdir -p /var/www/pro-electrician/logs
mkdir -p /var/www/pro-electrician/certs

# 设置权限
chmod 755 /var/www/pro-electrician/uploads
chmod 755 /var/www/pro-electrician/logs
chmod 600 /var/www/pro-electrician/certs/*
```

## 4. 数据库初始化

### 4.1 创建数据库表结构

```bash
# 如果使用自动同步（开发环境）
NODE_ENV=development node api/app.js

# 或者手动执行SQL脚本
mysql -h your-rds-endpoint -u your_user -p pro_electrician < database_schema.sql
```

### 4.2 导入初始数据（可选）

```bash
mysql -h your-rds-endpoint -u your_user -p pro_electrician < initial_data.sql
```

## 5. Nginx配置

### 5.1 创建Nginx配置文件

```bash
sudo vim /etc/nginx/sites-available/pro-electrician
```

**配置内容：**

```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # 代理到Node.js应用
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # WebSocket支持
    location /socket.io/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 静态文件
    location /uploads {
        alias /var/www/pro-electrician/uploads;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 健康检查
    location /health {
        proxy_pass http://localhost:3000;
        access_log off;
    }
}
```

### 5.2 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/pro-electrician /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

## 6. PM2进程管理

### 6.1 创建PM2配置文件

```bash
vim /var/www/pro-electrician/ecosystem.config.js
```

**配置内容：**

```javascript
module.exports = {
  apps: [{
    name: 'pro-electrician-api',
    script: './api/app.js',
    cwd: '/var/www/pro-electrician',
    instances: 'max', // 或者指定数量，如 2
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/pm2-error.log',
    out_file: './logs/pm2-out.log',
    log_file: './logs/pm2-combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024',
    watch: false,
    ignore_watch: ['node_modules', 'logs', 'uploads'],
    restart_delay: 4000,
    max_restarts: 10,
    min_uptime: '10s'
  }]
};
```

### 6.2 启动应用

```bash
cd /var/www/pro-electrician

# 启动应用
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs

# 保存PM2配置
pm2 save
```

## 7. 安全配置

### 7.1 防火墙配置

```bash
# Ubuntu (UFW)
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw deny 3000  # 禁止直接访问Node.js端口

# CentOS (firewalld)
sudo systemctl start firewalld
sudo systemctl enable firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 7.2 创建专用用户

```bash
# 创建应用用户
sudo useradd -r -s /bin/false electrician-app
sudo chown -R electrician-app:electrician-app /var/www/pro-electrician

# 更新PM2配置以使用专用用户
# 在ecosystem.config.js中添加:
# user: 'electrician-app'
```

### 7.3 SSL证书配置

```bash
# 使用Let's Encrypt免费证书
sudo apt install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

## 8. 监控和日志管理

### 8.1 日志轮转配置

```bash
sudo vim /etc/logrotate.d/pro-electrician
```

**配置内容：**

```
/var/www/pro-electrician/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 electrician-app electrician-app
    postrotate
        pm2 reloadLogs
    endscript
}
```

### 8.2 系统监控

```bash
# 安装htop和iotop
sudo apt install -y htop iotop

# PM2监控
pm2 install pm2-logrotate
pm2 monit
```

### 8.3 数据库备份

```bash
# 创建备份脚本
vim /var/www/pro-electrician/scripts/backup.sh
```

**备份脚本：**

```bash
#!/bin/bash
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="/var/backups/mysql"
DB_NAME="pro_electrician"
DB_USER="your_user"
DB_PASS="your_password"
DB_HOST="your-rds-endpoint"

mkdir -p $BACKUP_DIR
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/backup_$DATE.sql
gzip $BACKUP_DIR/backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete
```

```bash
# 设置执行权限
chmod +x /var/www/pro-electrician/scripts/backup.sh

# 添加到定时任务
crontab -e
# 添加：每天凌晨2点备份
# 0 2 * * * /var/www/pro-electrician/scripts/backup.sh
```

## 9. 部署验证

### 9.1 健康检查

```bash
# 检查服务状态
curl -f http://localhost:3000/health

# 检查通过Nginx的访问
curl -f https://your-domain.com/api/health

# 检查PM2状态
pm2 status

# 检查Nginx状态
sudo systemctl status nginx

# 检查数据库连接
mysql -h your-rds-endpoint -u your_user -p -e "SELECT 1;"
```

### 9.2 性能测试

```bash
# 安装ab工具
sudo apt install -y apache2-utils

# 简单压力测试
ab -n 1000 -c 10 https://your-domain.com/api/health
```

## 10. 常见问题排查

### 10.1 应用无法启动

```bash
# 查看PM2日志
pm2 logs

# 查看详细错误
pm2 logs pro-electrician-api --lines 100

# 检查环境变量
pm2 env 0

# 手动启动测试
cd /var/www/pro-electrician
node api/app.js
```

### 10.2 数据库连接问题

```bash
# 测试数据库连接
mysql -h your-rds-endpoint -u your_user -p

# 检查防火墙规则
sudo ufw status

# 检查RDS安全组设置
# 确保3306端口对ECS实例开放
```

### 10.3 Nginx配置问题

```bash
# 测试Nginx配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# 重新加载配置
sudo nginx -s reload
```

### 10.4 SSL证书问题

```bash
# 检查证书有效期
openssl x509 -in /path/to/certificate.crt -text -noout

# 测试SSL配置
openssl s_client -connect your-domain.com:443

# 续期Let's Encrypt证书
sudo certbot renew --dry-run
```

## 11. 维护和更新

### 11.1 代码更新流程

```bash
# 1. 备份当前版本
cp -r /var/www/pro-electrician /var/backups/pro-electrician-$(date +%Y%m%d)

# 2. 拉取最新代码
cd /var/www/pro-electrician
git pull origin main

# 3. 安装新依赖
npm install --production

# 4. 重启应用
pm2 restart pro-electrician-api

# 5. 验证部署
curl -f https://your-domain.com/api/health
```

### 11.2 回滚流程

```bash
# 如果更新出现问题，快速回滚
pm2 stop pro-electrician-api
rm -rf /var/www/pro-electrician
mv /var/backups/pro-electrician-YYYYMMDD /var/www/pro-electrician
pm2 start pro-electrician-api
```

### 11.3 定期维护任务

```bash
# 每周执行的维护脚本
vim /var/www/pro-electrician/scripts/weekly-maintenance.sh
```

```bash
#!/bin/bash
# 清理日志
find /var/www/pro-electrician/logs -name "*.log" -mtime +30 -delete

# 清理上传的临时文件
find /var/www/pro-electrician/uploads -name "temp_*" -mtime +1 -delete

# 更新系统包
sudo apt update && sudo apt upgrade -y

# 重启PM2以释放内存
pm2 restart all

# 检查磁盘空间
df -h

# 检查内存使用
free -h
```

## 12. 性能优化建议

### 12.1 Node.js应用优化

- 启用gzip压缩
- 使用Redis缓存热点数据
- 优化数据库查询
- 使用CDN加速静态资源

### 12.2 数据库优化

- 添加适当的索引
- 定期分析和优化查询
- 配置连接池
- 启用查询缓存

### 12.3 服务器优化

- 调整内核参数
- 优化文件描述符限制
- 配置swap分区
- 使用SSD存储

---

**部署完成后，您的电工维修平台将在阿里云上稳定运行。记得定期备份数据和监控系统状态！**